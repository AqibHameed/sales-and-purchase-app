<%hide_class = @trading_parcel.new_record? ? 'hide' : ''%>
<% dt = @trading_parcel.diamond_type %>
<%= nested_form_for @trading_parcel, remote: true, html: { class: 'form-horizontal' } do |f| %>
  <div class="tranding-parcel-errors">
    <%= render partial: 'suppliers/tranding_parcel_errors' %>
  </div>
  <%= f.hidden_field :diamond_type, :value => ' ' %>
  </br>
  <div class="clear10"></div>
  <div class="form-group">
    <label class="col-sm-2 control-label">Source:</label>
    <div class="col-sm-10">
      <%= f.select :source, options_for_select(supplier_list_for_demand, :selected => f.object.source), {include_blank: true}, {class: 'form-control'}%>
    </div>
  </div>

  <div class="sight_diamond <%=hide_class%> <%=(dt == 'Sight') ? '' : 'hide'%>">
    <div class="form-group">
      <label class="col-sm-2 control-label">Discount Per Month:</label>
      <div class="col-sm-10">
        <%= f.number_field :box_value, :value => 0, class: 'form-control' %>
      </div>
    </div>

    <div class="form-group">
      <label class="col-sm-2 control-label">Month Sight:</label>
      <div class="col-sm-10">
        <%= f.text_field :sight, class: 'form-control' %>
      </div>
    </div>
  </div>

  <div class="rough_diamond <%=hide_class%> <%=(dt == 'Rough') ? '' : 'hide'%>">
    <div class="form-group">
      <label class="col-sm-2 control-label">Lot No:</label>
      <div class="col-sm-10">
        <%= f.number_field :lot_no, class: 'form-control' %>
      </div>
    </div>
  </div>

  <div class="form-group">
    <label class="col-sm-2 control-label">Description:</label>
    <div class="col-sm-10">
      <%= f.select :description, options_for_select(parcel_list_for_demand(nil), @trading_parcel.description), {include_blank: true}, class: 'form-control' %>

    </div>
  </div>

  <div class="common <%=hide_class%>">

    <div class="form-group">
      <label class="col-sm-2 control-label">Credit:</label>
      <div class="col-sm-10">
        <%= f.number_field :credit_period, class: 'form-control' %>
        <%= f.hidden_field :customer_id, value: current_customer.id, class: 'form-control' %>
        <%= f.hidden_field :single_parcel, value: true, class: 'form-control' %>
        <%= f.hidden_field :company_id, value: current_company.id, class: 'form-control' %>
      </div>
    </div>

    <div class="form-group">
      <label class="col-sm-2 control-label">No of Stones:</label>
      <div class="col-sm-10">
        <%= f.number_field :no_of_stones, class: 'form-control' %>
      </div>
    </div>

    <div class="form-group">
      <label class="col-sm-2 control-label">Carats:</label>
      <div class="col-sm-10">
        <%= f.text_field :weight, class: 'form-control' %>
      </div>
    </div>

    <div class="form-group">
      <label class="col-sm-2 control-label">Cost:</label>
      <div class="col-sm-10">
        <%= f.text_field :cost, class: 'form-control' %>
      </div>
    </div>

    <div class="form-group">
      <label class="col-sm-2 control-label">Percent:</label>
      <div class="col-sm-10">
        <%= f.text_field :percent, class: 'form-control' %>
      </div>
    </div>

    <div class="form-group">
      <label class="col-sm-2 control-label">Avg Price:</label>
      <div class="col-sm-10">
        <%= f.text_field :price, class: 'form-control' %>
      </div>
    </div>

    <div class="form-group">
      <label class="col-sm-2 control-label">Total/Box Value:</label>
      <div class="col-sm-10">
        <%= f.number_field :total_value, class: 'form-control' %>
      </div>
    </div>

    <div class="form-group">
      <label class="col-sm-2 control-label">Comment:</label>
      <div class="col-sm-10">
        <%= f.text_area :comment, class: 'form-control' %>
      </div>
    </div>

    <div class="clear10"></div>
    <div class="row">
      <%= f.fields_for :parcel_size_infos, html: { class: 'form-inline' } do |s| %>
        <table class="table table-hover">
          <thead>
            <!-- <th>Carats</th> -->
            <th>Size</th>
            <th>Percent</th>
          </thead>
          <tbody>
            <tr>
              <!-- <td class="sub_c"><%#=s.text_field :carats, class: 'form-control col-sm-3 sub_carats' %></td> -->
              <td class="sub_s"><%=s.text_field :size, class: 'form-control col-sm-3 sub_size' %></td>
              <td class="sub_per"><%=s.text_field :percent, class: 'form-control col-sm-3 sub_percent' %></td>
              <td><%=s.link_to_remove "Remove", class: 'btn btn-xs btn-success mt5' %></td>
            </tr>
          </tbody>
        </table>
      <% end %>
    </div>

    <div class="clear10"></div>
    <div class="check-box-for-sale">
      <div class="form-group">
        <label class="col-sm-2 control-label">Select Parcel Visibility:</label>
        <div class="col-sm-10">
          <div class="col-md-2">
            <%= f.check_box :sale_all, class: 'form-check-input' %>
            <%= f.label "All", class: 'form-check-label' %>
          </div>

          <div class="col-md-2">
            <%= f.check_box :sale_none, class: 'form-check-input' %>
            <%= f.label "None", class: 'form-check-label' %>
          </div>

          <div class="col-md-2">
            <%= f.check_box :sale_broker, class: 'form-check-input' %>
            <%= f.label "Broker", class: 'form-check-label' %>
          </div>

          <div class="col-md-2">
            <%= f.check_box :sale_credit, class: 'form-check-input' %>
            <%= f.label "Credit Given", class: 'form-check-label' %>
          </div>

          <div class="col-md-2">
            <%= f.check_box :sale_demanded, class: 'form-check-input' %>
            <%= f.label "Demanded", class: 'form-check-label' %>
          </div>

        </div>
      </div>
    </div>

    <div class="clear10"></div>
    <div class="check-box-for-sale">
      <div class="form-group">
        <label class="col-sm-2 control-label">Anonymous:</label>
        <div class="col-sm-10">
          <div class="col-md-2">
            <%= f.check_box :anonymous, class: 'form-check-input', style: 'margin-left: -20px;' %>
          </div>
        </div>
      </div>
    </div>
    </br>

    <%= f.link_to_add "Add Size", :parcel_size_infos, class: 'btn btn-sm btn-info' %>
    <%=f.submit 'Submit', class: 'btn btn-md btn-danger' %>
  </div>
<% end %>

<script>
  $(document).on('keyup focusout','#trading_parcel_percent', function(){
    var carat = parseFloat($('#trading_parcel_weight').val());
    var cost = parseFloat($('#trading_parcel_cost').val());
    var percent = parseFloat($('#trading_parcel_percent').val());
    var price = parseFloat($('#trading_parcel_price').val());
    calculate_price(carat, cost, percent, price)
  });

  $(document).on('keyup focusout','#trading_parcel_price', function(){
    var carat = parseFloat($('#trading_parcel_weight').val());
    var cost = parseFloat($('#trading_parcel_cost').val());
    var price = parseFloat($('#trading_parcel_price').val());
    calculate_percent(carat, cost, price)
  });

  function calculate_price(carat, cost, percent, price){
    var avg_price = (percent/100)*cost + cost;
    var amount = carat*avg_price;
    if (isNaN(avg_price)){
      $('#trading_parcel_price').val('')
      $('#amount').val('');
      $('#trading_parcel_total_value').val('')
    }else{
      $('#trading_parcel_price').val(avg_price)
      $('#amount').val(amount);
      $('#trading_parcel_total_value').val(amount)
    }
  }

  function calculate_percent(carat, cost, price){
    var percent = ((price - cost) * 100)/cost;
    var amount = carat*price;
    if (isNaN(percent)){
      $('#trading_parcel_percent').val('')
      $('#amount').val(amount);
      $('#trading_parcel_total_value').val('')
    }else{
      $('#trading_parcel_percent').val(percent)
      $('#amount').val(amount);
      $('#trading_parcel_total_value').val(amount)
    }
  }

  $(document).on('change','#trading_parcel_sale_all, #trading_parcel_sale_none, #trading_parcel_sale_broker, #trading_parcel_sale_demanded, #trading_parcel_sale_credit', function(){
    self = $(this)
    disable_button(self)
  });

  function disable_button(self){
    self_checked = self.prop('checked')
    if (self.attr('name') == 'trading_parcel[sale_all]') {
      sale_all_and_none(self_checked, false)
      disable_demand_broker_credit()
    }  else if (self.attr('name') == 'trading_parcel[sale_none]') {
      sale_all_and_none(false, self_checked)
      disable_demand_broker_credit()
    } else {
      sale_all_and_none(false, false)
    }
  }

  function disable_demand_broker_credit() {
    $('#trading_parcel_sale_broker').prop('checked', false)
    $('#trading_parcel_sale_demanded').prop('checked', false)
    $('#trading_parcel_sale_credit').prop('checked', false)
  }

  function sale_all_and_none(sale_all, sale_none) {
    $('#trading_parcel_sale_all').prop('checked', sale_all)
    $('#trading_parcel_sale_none').prop('checked', sale_none)
  }
</script>
