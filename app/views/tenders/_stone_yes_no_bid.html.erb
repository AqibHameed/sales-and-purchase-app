<div class="table">
  <table width="100%" border="0" cellspacing="0" cellpadding="0" id="myTable_stones" class="tablesorter">
    <thead>
      <tr>
        <% if current_customer %>
          <th>Imp&nbsp;&nbsp;&nbsp;&nbsp;</th>
          <th>Read&nbsp;&nbsp;&nbsp;&nbsp;</th>
        <% end %>
        <th>Lot No</th>
        <th>Description</th>
        <th>Stones&nbsp;&nbsp;&nbsp;&nbsp;</th>
        <th>Carat</th>
        <th>System Price</th>
        <% if current_customer %>
          <th>Winning price</th>
          <th>My Note</th>
        <% end %>
        <th>History&nbsp;&nbsp;&nbsp;&nbsp;</th>
        <th>Yes / No</th>
      </tr>
    </thead>
    <tbody>
      <% @stones.each_with_index do |stone,i| %>
         <% unless stone.description == "Description" || stone.description == "DESCRIPTION"%>
            <% current_round = @tender.round %>
            <% stone_winner = stone.yes_no_buyer_winner %>

              <tr class="<%= get_color(@diff, stone.description) %> ">
                <% if current_customer %>
                  <td><div id_key="<%= stone.id %>" key="<%= stone.key %>" score='<%= @important.include?(stone.key) ? 1 : 0 %>' id="star_<%= stone.id %>" class="star" ></div><span class="score"><%= @important.include?(stone.key) ? 1 : 0%></span></td>
                  <td><%= check_box_tag "read",1,@read.include?(stone.key) ,{:id => "read_" + stone.id.to_s, :class => "read", :key => stone.key} %><span class="score"><%= @read.include?(stone.key) ? 1 : 0 %></span></td>
                <% end %>
                <td><%= stone.lot_no %></td>
                <td><%= stone.description %></td>
                <td><%= stone.no_of_stones %></td>
                <td><%= stone.weight %></td>
                <td class = "yes_no_reserved_price" >
                <% if current_round == 1 %>
                  <%= stone.reserved_price.present? ? stone.reserved_price - ((20.to_f/100.to_f)*stone.reserved_price) : "empty price" %>
                <% else %>
                  <%= stone.stone_winning_price.present? ? stone.stone_winning_price : (stone.yes_no_system_price.present? ? stone.yes_no_system_price : stone.reserved_price.to_f - ((20.to_f/100.to_f)*stone.reserved_price.to_f)) %>
                <% end %>
                </td>
                <% if current_customer %>
                  <td><%= stone.stone_winning_price.present? ? stone.stone_winning_price : "" %></td>
                  <td>
                    <span id="note-<%= i %>"><%= image_tag('icon-notes.png') if @notes.include?(stone.key) %></span>
                     <%= link_to 'Note', add_note_tender_path(@tender.id, :key => stone.key, :stone_id => stone.id, :deec_no => stone.deec_no, :index => i), :class => 'add_note' %>
                  </td>
                <% end %>
                  <td><%= link_to "View", view_past_result_tender_path(@tender.id, :stone_id => stone.id, :key => stone.description, stone_count: stone.no_of_stones), :class => "past_result_link" %></td>
                  <td>
                    <% if current_round == 1 && DateTime.now.to_i < @tender.round_open_time.to_i %>
                      Pending
                    <% elsif @tender.break_time %>
                      break
                    <% elsif stone.stone_winning_price.present? && stone_winner.try(:customer_id) == current_customer.id %>
                      Winner
                    <% elsif stone.stone_winning_price.present? && stone_winner.try(:customer_id) != current_customer.id %>

                    <% elsif DateTime.now.to_i > @tender.round_open_time.to_i && current_round == 1 %>
                      uper
                      <label class="switch">
                        <input class="switch-input" type="checkbox" />
                        <span class="switch-label" data-on="Yes" data-off="No"></span>
                        <span class="switch-handle"></span>
                      </label>
                    <% elsif current_round > 1 && current_customer.can_bid_on_parcel('stone', current_round, @tender, stone) %>
                      here
                      <%#=current_customer.can_bid_on_parcel('stone', current_round, @tender, stone).inspect %>
                      <%#=@tender.round_open_time.to_i %>
                      <%#= Time.now.to_i %>
                      <label class="switch">
                        <input class="switch-input" type="checkbox" />
                        <span class="switch-label" data-on="Yes" data-off="No"></span>
                        <span class="switch-handle"></span>
                      </label>
                    <% else %>
                      Withdrawn
                    <% end %>
                    <input type="hidden" class="yes_no_stone_id" value="<%= stone.id %>">
                    <input type="hidden" class="yes_no_tender_id" value="<%= @tender.id %>">
                    <!-- <input type="hidden" class="yes_no_buyer_left" value="<%#= is_checked.buyer_left %>"> -->
                </td>
              </tr>

        <%end%>
      <% end %>
    </tbody>

  </table>
</div>
<script type="text/javascript">
  $(document).ready(function() {
    addStarRatings('<%= @tender.id %>')
    addRead('<%= @tender.id %>')
    $(document).on('click', '.place_bid', function(e) {
      e.preventDefault()
      var _this = $(this);
      var top = $(this).position()['top'] - 300;
      var url = $(this).attr('href')
      $.ajax({
        url : url,
        type : 'GET',
        success : function(response) {
          $('.bid_form').html(response).show()
          // $('.bid_form').css('margin-top', top + 'px' )
          $('tr').removeClass('current_bid');
          $(_this).parents('tr').addClass('current_bid');
        }
      })
    });

    $(document).on('click', '.add_note', function(e) {
      e.preventDefault()
      var _this = $(this);
      var top = $(this).position()['top'] - 300;
      var url = $(this).attr('href')
      $.ajax({
        url : url,
        type : 'GET',
        success : function(response) {
          $('.bid_form').html(response).show()
          // $('.bid_form').css('margin-top', top + 'px' )
          $('tr').removeClass('current_bid');
          $(_this).parents('tr').addClass('current_bid');
        }
      })
    });

    $(document).on('click', '.past_result_link', function(e) {
    e.preventDefault()
    var _this = $(this);
    var top = $(this).position()['top'] - 300;
    var url = $(this).attr('href')
    $.ajax({
      url : url,
      type : 'GET',
      success : function(response) {
        $('.bid_form').html(response).show()
        // $('.bid_form').css('margin-top', top + 'px' )
        $('tr').removeClass('current_bid');
        $(_this).parents('tr').addClass('current_bid');
      }
    })
  });

    $(document).ready(function() {
      $('.switch-input').on('change', function() {
        var isChecked = $(this).is(':checked');
        var selectedData;
        var $switchLabel = $('.switch-label');
        console.log('isChecked: ' + isChecked);
        if(isChecked) {
          selectedData = $switchLabel.attr('data-on');
          var stone_id = $(this).closest('tr').find('.yes_no_stone_id').val();
          var tender_id = $(this).closest('tr').find('.yes_no_tender_id').val();
          var reserved_price = $(this).closest('tr').find('.yes_no_reserved_price').html();
          var current_customer = "<%= current_customer.id %>"
          var interest = selectedData
          var data = {"stone_id": stone_id, "tender_id": tender_id, "current_customer": current_customer, "interest": interest, "reserved_price": $.trim(reserved_price.replace(/[\n]+/g,' ')) }
          $.ajax({
              url:"/tenders/yes_or_no_winners",
              type:'POST',
              dataType:'json',
              data:{data},
              success:function(data){
                console.log("success");
              },
              error:function(data){
                console.log("error")
              }
            });
        } else {
          selectedData = $switchLabel.attr('data-off');
          var stone_id = $(this).closest('tr').find('.yes_no_stone_id').val();
          var tender_id = $(this).closest('tr').find('.yes_no_tender_id').val();
          var reserved_price = $(this).closest('tr').find('.yes_no_reserved_price').html();
          var current_customer = "<%= current_customer.id %>"
          var interest = selectedData
          var data = {"stone_id": stone_id, "tender_id": tender_id, "current_customer": current_customer, "interest": interest, "reserved_price": $.trim(reserved_price.replace(/[\n]+/g,' ')) }
          console.log(data)
          $.ajax({
            url:"/tenders/yes_or_no_winners",
            type:'POST',
            dataType:'json',
            data:{data},
            success:function(data){
              console.log("success");
            },
            error:function(data){
              console.log("error")
            }
          });
        }
        console.log('Selected data: ' + selectedData);
      });
      // Params ($selector, boolean)
      function setSwitchState(el, flag) {
        el.attr('unchecked', flag);
      }
      // Usage
      setSwitchState($('.switch-input'), true);
    });

  })



</script>

<style>
  .current_bid {
    background-color: #E4E4E4 !important;
  }
</style>