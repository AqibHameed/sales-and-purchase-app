class Tender < ActiveRecord::Base

  attr_accessible :name, :description, :open_date, :close_date, :tender_open, :user_ids, :document

  has_and_belongs_to_many :users

  has_attached_file :document

  scope :open_tenders, lambda{|date| where("close_date >= ?", date.beginning_of_day) }

  scope :closed_tenders, lambda{|date| where("close_date < ?", date.end_of_day) }

  scope :active_open_for_dates, lambda{|start_date, end_date|
    where("(open_date >= ? AND open_date <= ?)", start_date.beginning_of_day, end_date.end_of_day)
  }

  scope :active_close_for_dates, lambda{|start_date, end_date|
    where("(close_date <= ? AND close_date >= ?)", end_date.end_of_day, start_date.beginning_of_day)
  }

  validates_attachment_content_type :document, :content_type => "application/pdf", :message => 'Only *.pdf files allowed'

  def send_confirmation?
    self.send_confirmation ? 'Yes' : 'No'
  end

  def self.tenders_for_calender(start_date, end_date)
    @open_data = Tender.active_open_for_dates(start_date, end_date)
    @close_data = Tender.active_close_for_dates(start_date, end_date)

    @hash = []

    @open_data.each do |d|
      op = {}
      op['id'] = d.id
      op['title'] = d.name
      op['color'] = 'green'
      op['url'] = ''
      op['allDay'] = false
      op['start'] = d.open_date.in_time_zone('Mumbai')
      op['end'] = d.open_date.advance(:minutes => 30)
      @hash << op
    end

    @close_data.each do |d|
      op = {}
      op['id'] = d.id
      op['title'] = d.name
      op['color'] = 'red'
      op['url'] = ''
      op['allDay'] = false
      op['start'] = d.close_date
      op['end'] = d.close_date.advance(:minutes => 30)
      @hash << op
    end

    @hash
  end


end

