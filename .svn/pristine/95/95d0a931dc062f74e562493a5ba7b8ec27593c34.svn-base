class BidsController < ApplicationController

  before_filter :authenticate_customer!

  def create
    @stone = Stone.find(params[:stone_id])
    @bid = Bid.find_or_initialize_by_stone_id_and_customer_id(params[:stone_id], current_customer.id)
    @tender = @stone.tender
    @bid.total = params[:bid][:total]
    @bid.price_per_carat = params[:bid][:price_per_carat]
    if @bid.save
      respond_to do |format|
        format.js { render 'tenders/refresh_data.js.erb'}
        format.html {redirect_to @bid.stone.tender}
      end
    else
      puts @bid.errors.inspect
      respond_to do |format|
        format.js {render :text => 'Error'}
        format.html {redirect_to @bid.stone.tender}
      end
    end

  end

  def update
    @bid = Bid.find(params[:id])
    @stone = @bid.stone
    @tender = @bid.stone.tender
    if @bid.update_attributes(params[:bid])
      respond_to do |format|
        format.js { render 'tenders/refresh_data.js.erb'}
        format.html {redirect_to @bid.stone.tender}
      end
    else
      puts @bid.errors.inspect
      respond_to do |format|
        format.js {render :text => 'Error'}
        format.html {redirect_to @bid.stone.tender}
      end
    end
  end

  def place_new
    @stone = Stone.find(params[:stone_id])
    tender = @stone.tender
    past_tender = Tender.find(:last, :conditions => ["id != ? and company_id = ? and created_at < ?",tender.id, tender.company_id, tender.created_at])
    @past_winner = past_tender.tender_winners.find_by_description(@stone.description)
     
    logger.info "---------------------------------"
    logger.info @past_winner
    logger.info "---------------------------------"
     
    @bid = Bid.find_or_initialize_by_stone_id_and_customer_id(params[:stone_id], current_customer.id)
    render :partial => 'place_new'
  end

end

