<div class=''>
  <div class=''>
    <div class='tender-detail'>
	<input type="hidden" id="past_bid" value="<%= @past_winner.nil? ? '' : @past_winner.avg_selling_price  %>" >
      <!--  Form Wrapper Start -->
      <div class="form-wrapper tend-detail">
        <%= form_for [@stone, @bid], :remote => true do |f| %>
          <%= f.hidden_field :customer_id %>
        <div class='form-row'>
          <div class='label'>
            Tender
          </div>
          <div class='field'>
            <strong><%= @stone.tender.name %></strong>
          </div>
          <div class='clear'></div>
        </div>
        <div class='form-row'>
          <div class='label'>
            Parcel Deec No.
          </div>
          <div class='field'>
            <%= @stone.deec_no %>
          </div>
          <div class='clear'></div>
        </div>
        <div class='form-row'>
          <div class='label'>
            Lot No
          </div>
          <div class='field'>
            <%= @stone.lot_no %>
          </div>
          <div class='clear'></div>
        </div>
        <div class='form-row'>
          <div class='label'>
            Description
          </div>
          <div class='field'>
            <%= @stone.description %>
          </div>
          <div class='clear'></div>
        </div>
        <div class='form-row'>
          <div class='label'>
            Carat
          </div>
          <div class="field parcel_weight">
            <%= @stone.weight %>
          </div>
          <div class='clear'></div>
        </div>
        
          <div class="form-row">
	          <div class="label">
		          Last Tender Avg. selling Price 
	          </div>
	          <div class="field" style='width:60%!important'>
		          <%= @past_winner.nil? ? 'N/A' : @past_winner.avg_selling_price  %>
		          <br><span class='amount_error' style="color:red; font-size:13px"></span>
	          </div>
	          <div class="clear"></div>
	      </div>

      
          <div class="form-row">
	          <div class="label">
		          Price per carat
	          </div>
	          <div class="field" style='width:60%!important'>
		          <%= f.text_field :price_per_carat, :style => 'width:150px;', :placeholder => 'Price per carat', :class => "input-1 price_per_carat" %>
		          <br><span class='amount_error' style="color:red; font-size:13px"></span>
	          </div>
	          <div class="clear"></div>
	      </div>
	      
          <div class="form-row">
	          <div class="label">
		          Total Bid
	          </div>
	          <div class="field" style='width:60%!important'>
		          <%= f.text_field :total, :style => 'width:150px;', :placeholder => 'Total bid', :class => "input-1 total_bid" %>
		          <br><span class='amount_error' style="color:red; font-size:13px"></span>
	          </div>
	          <div class="clear"></div>
          </div>

	      
          <div class="form-row">
	          <div class="label">
		          Diff. from last winning bid
	          </div>
	          <div class="field" style='width:60%!important'>
		          <span id="bid_percent_container">-</span>
		      </div>
	          <div class="clear"></div>
	      </div>

          <div class="clear10"></div>
          <div class="form-row">
	          <div class="label" style='width:25%!important'>
		          &nbsp;
	          </div>
	          <div class="field" style='width:60%!important'>
		          <%= f.submit "Save", :class => 'btn-01 submit_bid' %>
		          <%= button_tag "Cancel", :class => 'btn-01 submit_bid', :onclick => "$('tr').removeClass('current_bid');$('.bid_form').html('').hide();removeMask();" %>
	          </div>
	          <div class="clear"></div>
          </div>
          <div class="clear10"></div>
          <% end %>



      </div>
      <!-- form Wrapper End -->

      <div class='clear'></div>


    </div>
    <div class='clear'></div>
  </div>
</div>


<script type='text/javascript'>

	addMask();

  $(document).ready(function(){

    $(document).on('click', '.submit_bid', function(e){
      $('.amount_error').html('')

      if( $('.total_bid').val() == '' && $('.price_per_carat').val() == '' ){
        e.preventDefault();
        $('.amount_error').html("can't be blank");
      } else{
        if( $('.total_bid').val() == '' ){
          calculateTotalAmount()
        } else{
          if( $('.price_per_carat').val() == '' ){
            calculatePricePerCarat()
          }
        }
      }

    })

    $(document).on('keydown', '.total_bid, .price_per_carat', function(e){
      if( validateKey(e.keyCode) ){
       // console.log('valid')
      } else {
        e.preventDefault()
      }
    })

    $(document).on('keyup', '.total_bid', function(e){
      calculatePricePerCarat()
    })

    $(document).on('keyup', '.price_per_carat', function(e){
      calculateTotalAmount()
    })

  })

  function validateKey(key){
    if ( key == 8 || key == 190 || key == 110 || (key <= 105 && key >= 96) || (key <= 57 && key >= 48) ){
      return true;
    } else {
      return false;
    }
  }
  


  function calculatePricePerCarat(){

    var price_per_carat, weight, total_bid;

    weight = parseFloat($('.parcel_weight').html());
    total_bid = parseFloat( $('.total_bid').val() );

    price_per_carat = total_bid/weight;

    if( isNaN(price_per_carat) ){
      $('.price_per_carat').val('');
    } else {
      price_per_carat = (Math.round(price_per_carat * 100) / 100);
      $('.price_per_carat').val( price_per_carat );
    }

	showDiff()

  }

  function calculateTotalAmount(){

    var weight, price_per_carat, total_bid;

    weight = parseFloat($('.parcel_weight').html());
    price_per_carat = parseFloat( $('.price_per_carat').val() );
    total_bid = price_per_carat * weight;

    if( isNaN(total_bid) ){
      $('.total_bid').val('')
    } else {
      total_bid = (Math.round(total_bid * 100) / 100);
      $('.total_bid').val(total_bid)

    }
	showDiff()
  }
  
  function showDiff(){
  	var diff = $('#past_bid').val()
  	var my_val = $('.price_per_carat:last').val()
  	
  	if(!(diff == '' || my_val == '' )){
  		var per_diff = 0
  		
  		per_diff = 100 - (my_val/diff * 100)
  		if(per_diff > 0){
  			var color='green';
  			var type = 'Less'
  		}else{
  			var color='red';
  			var type = 'High'
  		}
  		$('#bid_percent_container').html(Math.abs(Math.round(per_diff * 100 ) / 100) + '% ' + type).css({'color':color}); 
  	}
  	
  }
  showDiff()
  
</script>

