class WinnersController < ApplicationController

  before_filter :authenticate_admin!
  def list
    @tenders = Tender.all
  end

  def bidders
    @tender = Tender.find(params[:tender_id])
    @stones = @tender.stones

    respond_to do |format|

      format.xls{

        filename = "Bidders List - #{@tender.name} #{@tender.open_date.strftime('%B')} #{@tender.open_date.year}.xls"
        headers["Content-Disposition"] = "attachment; filename=\"#{filename}\""

      }
      
      format.html

    end

  end

  def winner

    @tender = Tender.find(params[:tender_id])
    @stones = @tender.stones

    winners = TenderWinner.find_all_by_tender_id(@tender.id)

    @winner_list = {}
    winners.each do |w|
      @winner_list[w.lot_no] = w.selling_price
    end

    respond_to do |format|

      format.xls{

        filename = "Winners List - #{@tender.name} #{@tender.open_date.strftime('%B')} #{@tender.open_date.year}.xls"
        headers["Content-Disposition"] = "attachment; filename=\"#{filename}\""

      }
      
      format.html

    end

  end

  def save
    @winner_attr = params['winner']
    unless @winner_attr.nil?
      @winner_attr.each do |k, winner_attr|
        unless winner_attr['bid_id'].blank?
          Winner.create(winner_attr)
        end
      end
    end
    redirect_to winner_winners_path(:tender_id => params[:tender_id])
  end

end

