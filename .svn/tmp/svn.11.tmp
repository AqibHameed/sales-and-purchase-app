class Stone < ActiveRecord::Base

  attr_accessible :stone_type, :no_of_stones, :weight, :carat, :purity, :color, :polished, :size,
                  :deec_no, :lot_no, :description, :tender_id

  has_many :bids
  has_one :winner
  
  

  validates_presence_of :deec_no, :lot_no, :tender_id

  validates_numericality_of :no_of_stones, :weight, :carat, :allow_blank => true

  belongs_to :tender

  def per_carat_bid(customer)
    bid = self.bids.find_by_customer_id(customer.id)
    bid.blank? ? '' : bid.price_per_carat
  end

  def total_bid(customer)
    bid = self.bids.find_by_customer_id(customer.id)
    bid.blank? ? '' : bid.total
  end

  def name
    self.lot_no.blank? ? "stone #{self.id}" : self.lot_no
  end

  def top_bid
    stone_id = self.id
    Bid.find_by_sql("
      SELECT b.* FROM tenders t
      INNER JOIN customers_tenders ct ON t.id = ct.tender_id
      INNER JOIN customers c ON c.id = ct.customer_id
      INNER JOIN bids b ON (b.customer_id = c.id AND b.tender_id = t.id)
      where ct.confirmed = #{true}
      AND b.stone_id = #{self.id}
      ORDER BY b.total DESC, b.id ASC
      LIMIT 1
    ")
#    self.bids.order('total DESC, id ASC').limit(1)
  end

  rails_admin do
    list do
      [:tender, :stone_type, :deec_no, :description, :no_of_stones, :weight].each do |field_name|
        field field_name
      end
    end
    edit do
      field :tender
      field :stone_type, :enum do
        enum do
          ['Stone', 'Parcel']
        end
      end
      [:deec_no, :lot_no, :description, :no_of_stones, :weight].each do |field_name|
        field field_name
      end
    end
  end

end

